### Copyright (C) 2011 Peter Williams <peter_ono@users.sourceforge.net>
###
### This program is free software; you can redistribute it and/or modify
### it under the terms of the GNU General Public License as published by
### the Free Software Foundation; version 2 of the License only.
###
### This program is distributed in the hope that it will be useful,
### but WITHOUT ANY WARRANTY; without even the implied warranty of
### MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
### GNU General Public License for more details.
###
### You should have received a copy of the GNU General Public License
### along with this program; if not, write to the Free Software
### Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA

Test the 'darn diff' command.

Set up a small file tree and initialise a playground therein
$ mkdir sub1
$ mkdir sub2
$ mkdir sub2/sub1
$ mkfile file1
< File 1: arbitrary content
$ mkfile file2
< File 2: arbitrary content
$ mkfile file3
< File 3: arbitrary content
$ mkfile sub1/file1
< File 1-1: arbitrary content
$ mkfile sub1/file2
< File 1-2: arbitrary content
$ mkfile sub1/file3
< File 1-3: arbitrary content
$ mkfile sub2/file1
< File 2-1: arbitrary content
$ mkfile sub2/file2
< File 2-2: arbitrary content
$ mkfile sub2/file3
< File 2-3: arbitrary content
$ mkfile sub2/sub1/file1
< File 2-1-1: arbitrary content
$ mkfile sub2/sub1/file2
< File 2-1-2: arbitrary content
$ mkfile sub2/sub1/file3
< File 2-1-3: arbitrary content

Create some patch files
$ mkfile patch1
< First patch
< --
< diff --git a/file1 b/file1
< --- a/file1
< +++ b/file1
< @@ -1 +1,2 @@
<  File 1: arbitrary content
< +a new line
< diff --git a/sub1/file1 b/sub1/file1
< --- a/sub1/file1
< +++ b/sub1/file1
< @@ -1 +1,2 @@
<  File 1-1: arbitrary content
< +a new line
< diff --git a/sub2/file1 b/sub2/file1
< --- a/sub2/file1
< +++ b/sub2/file1
< @@ -1 +1,2 @@
<  File 2-1: arbitrary content
< +a new line
< diff --git a/sub2/sub1/file1 b/sub2/sub1/file1
< --- a/sub2/sub1/file1
< +++ b/sub2/sub1/file1
< @@ -1 +1,2 @@
<  File 2-1-1: arbitrary content
< +a new line

A patch ehich will require merging
$ mkfile patch2
< Second patch
< --
< diff --git a/file1 b/file1
< --- a/file1
< +++ b/file1
< @@ -1,2 +1,3 @@
<  File 1: arbitrary content KKKKK
<  a new line
< +another new line
< diff --git a/sub1/file1 b/sub1/file1
< --- a/sub1/file1
< +++ b/sub1/file1
< @@ -1,2 +1,3 @@
<  File 1-1: arbitrary content
<  a new line
< +another new line
< diff --git a/sub2/file1 b/sub2/file1
< --- a/sub2/file1
< +++ b/sub2/file1
< @@ -1,2 +1,3 @@
<  File 2-1: arbitrary content
<  a new line
< +another new line
< diff --git a/sub2/sub1/file1 b/sub2/sub1/file1
< --- a/sub2/sub1/file1
< +++ b/sub2/sub1/file1
< @@ -1,2 +1,3 @@
<  File 2-1-1: arbitrary content
<  a new line
< +another new line

$ darn init
$ darn import patch1
> file1: file added to patch "patch1".
> sub1/file1: file added to patch "patch1".
> sub2/file1: file added to patch "patch1".
> sub2/sub1/file1: file added to patch "patch1".
> patch1: patch inserted at start of series.
> Imported "patch1" as patch "patch1".
$ darn push
> Patching file "sub2/file1".
> Patching file "sub2/sub1/file1".
> Patching file "file1".
> Patching file "sub1/file1".
> Patch "patch1" is now on top.
$ darn files
>  :+: file1
>  :+: sub1/file1
>  :+: sub2/file1
>  :+: sub2/sub1/file1
$ darn diff --notimestamps
> diff --git a/file1 b/file1
> --- a/file1
> +++ b/file1
> @@ -1 +1,2 @@
>  File 1: arbitrary content
> +a new line
> diff --git a/sub1/file1 b/sub1/file1
> --- a/sub1/file1
> +++ b/sub1/file1
> @@ -1 +1,2 @@
>  File 1-1: arbitrary content
> +a new line
> diff --git a/sub2/file1 b/sub2/file1
> --- a/sub2/file1
> +++ b/sub2/file1
> @@ -1 +1,2 @@
>  File 2-1: arbitrary content
> +a new line
> diff --git a/sub2/sub1/file1 b/sub2/sub1/file1
> --- a/sub2/sub1/file1
> +++ b/sub2/sub1/file1
> @@ -1 +1,2 @@
>  File 2-1-1: arbitrary content
> +a new line

$ darn import patch2
> file1: file added to patch "patch2".
> sub1/file1: file added to patch "patch2".
> sub2/file1: file added to patch "patch2".
> sub2/sub1/file1: file added to patch "patch2".
> patch2: patch inserted after patch "patch1".
> Imported "patch2" as patch "patch2".
$ darn push
> Patching file "sub2/file1".
> Patching file "sub2/sub1/file1".
> Patching file "file1".
! file1: Hunk #1 merged at 3.
> Patching file "sub1/file1".
> Patch "patch2" is now on top.
$ darn files
>  :?: file1
>  :+: sub1/file1
>  :+: sub2/file1
>  :+: sub2/sub1/file1
$ darn refresh
$ darn files
>  :+: file1
>  :+: sub1/file1
>  :+: sub2/file1
>  :+: sub2/sub1/file1
$ darn diff --notimestamps
> diff --git a/file1 b/file1
> --- a/file1
> +++ b/file1
> @@ -1,2 +1,3 @@
>  File 1: arbitrary content
>  a new line
> +another new line
> diff --git a/sub1/file1 b/sub1/file1
> --- a/sub1/file1
> +++ b/sub1/file1
> @@ -1,2 +1,3 @@
>  File 1-1: arbitrary content
>  a new line
> +another new line
> diff --git a/sub2/file1 b/sub2/file1
> --- a/sub2/file1
> +++ b/sub2/file1
> @@ -1,2 +1,3 @@
>  File 2-1: arbitrary content
>  a new line
> +another new line
> diff --git a/sub2/sub1/file1 b/sub2/sub1/file1
> --- a/sub2/sub1/file1
> +++ b/sub2/sub1/file1
> @@ -1,2 +1,3 @@
>  File 2-1-1: arbitrary content
>  a new line
> +another new line
$ darn diff --notimestamps --combined
> diff --git a/file1 b/file1
> --- a/file1
> +++ b/file1
> @@ -1 +1,3 @@
>  File 1: arbitrary content
> +a new line
> +another new line
> diff --git a/sub1/file1 b/sub1/file1
> --- a/sub1/file1
> +++ b/sub1/file1
> @@ -1 +1,3 @@
>  File 1-1: arbitrary content
> +a new line
> +another new line
> diff --git a/sub2/file1 b/sub2/file1
> --- a/sub2/file1
> +++ b/sub2/file1
> @@ -1 +1,3 @@
>  File 2-1: arbitrary content
> +a new line
> +another new line
> diff --git a/sub2/sub1/file1 b/sub2/sub1/file1
> --- a/sub2/sub1/file1
> +++ b/sub2/sub1/file1
> @@ -1 +1,3 @@
>  File 2-1-1: arbitrary content
> +a new line
> +another new line
