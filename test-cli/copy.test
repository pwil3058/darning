### Copyright (C) 2011 Peter Williams <peter_ono@users.sourceforge.net>
###
### This program is free software; you can redistribute it and/or modify
### it under the terms of the GNU General Public License as published by
### the Free Software Foundation; version 2 of the License only.
###
### This program is distributed in the hope that it will be useful,
### but WITHOUT ANY WARRANTY; without even the implied warranty of
### MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
### GNU General Public License for more details.
###
### You should have received a copy of the GNU General Public License
### along with this program; if not, write to the Free Software
### Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA

Test the 'darn add' command.

Create some test files.
$ mkfile file1
< file one
$ mkfile file2
< file two
$ mkfile file3
< file three
$ mkfile file4
< file four

Make a playground and patch
$ darn init
$ darn new first
$ darn add file4
> file4: file added to patch "first".
$ patch -e file4
< a
< a change which will be lost
< .

Copy nonexistent file
$ darn copy nonexistent nonexistent.copy
? 1
! nonexistent: file does not exist.
$ darn copy nonexistent file1
? 1
! nonexistent: file does not exist.
$ darn copy nonexistent file4
? 1
! nonexistent: file does not exist.

Make a simple copy
$ darn copy file1 file1.copy
> file1: file copied to "file1.copy" in patch "first".
$ darn files
> +:+: file1.copy <<- file1
>  :?: file4
$ darn diff --notimestamp
> diff --git a/file1 b/file1.copy
> copy from file1
> copy to file1.copy
> diff --git a/file4 b/file4
> --- a/file4
> +++ b/file4
> @@ -1,1 +1,2 @@
>  file four
> +a change which will be lost
$ patch -e file1.copy
< a
< a change
<.
$ darn diff --notimestamp
> diff --git a/file1 b/file1.copy
> copy from file1
> copy to file1.copy
> --- a/file1.copy
> +++ b/file1.copy
> @@ -1,1 +1,2 @@
>  file one
> +a change
> diff --git a/file4 b/file4
> --- a/file4
> +++ b/file4
> @@ -1,1 +1,2 @@
>  file four
> +a change which will be lost
$ darn files
> +:?: file1.copy <<- file1
>  :?: file4

Copy a copy
$ darn copy file1.copy file1.copy.copy
> file1.copy: file copied to "file1.copy.copy" in patch "first".
$ darn files
> +:?: file1.copy <<- file1
> +:?: file1.copy.copy <<- file1
>  :?: file4
$ darn diff --notimestamp
> diff --git a/file1 b/file1.copy
> copy from file1
> copy to file1.copy
> --- a/file1.copy
> +++ b/file1.copy
> @@ -1,1 +1,2 @@
>  file one
> +a change
> diff --git a/file1 b/file1.copy.copy
> copy from file1
> copy to file1.copy.copy
> --- a/file1.copy.copy
> +++ b/file1.copy.copy
> @@ -1,1 +1,2 @@
>  file one
> +a change
> diff --git a/file4 b/file4
> --- a/file4
> +++ b/file4
> @@ -1,1 +1,2 @@
>  file four
> +a change which will be lost

Simple overwrite
$ darn copy file2 file3
> file2: file copied to "file3" in patch "first".
$ darn files
> +:?: file1.copy <<- file1
> +:?: file1.copy.copy <<- file1
>  :+: file3 <<- file2
>  :?: file4
$ patch -e file3
< a
< modify overwritten
<.
$ darn files
> +:?: file1.copy <<- file1
> +:?: file1.copy.copy <<- file1
>  :?: file3 <<- file2
>  :?: file4
$ darn diff --notimestamp
> diff --git a/file1 b/file1.copy
> copy from file1
> copy to file1.copy
> --- a/file1.copy
> +++ b/file1.copy
> @@ -1,1 +1,2 @@
>  file one
> +a change
> diff --git a/file1 b/file1.copy.copy
> copy from file1
> copy to file1.copy.copy
> --- a/file1.copy.copy
> +++ b/file1.copy.copy
> @@ -1,1 +1,2 @@
>  file one
> +a change
> diff --git a/file2 b/file3
> copy from file2
> copy to file3
> --- a/file3
> +++ b/file3
> @@ -1,1 +1,2 @@
>  file two
> +modify overwritten
> diff --git a/file4 b/file4
> --- a/file4
> +++ b/file4
> @@ -1,1 +1,2 @@
>  file four
> +a change which will be lost

Overwrite a tracked file
$ darn copy file2 file4
? 17
! file4: file already in patch.
$ darn copy --overwrite file2 file4
> file2: file copied to "file4" in patch "first".
$ darn diff --notimestamp
> diff --git a/file1 b/file1.copy
> copy from file1
> copy to file1.copy
> --- a/file1.copy
> +++ b/file1.copy
> @@ -1,1 +1,2 @@
>  file one
> +a change
> diff --git a/file1 b/file1.copy.copy
> copy from file1
> copy to file1.copy.copy
> --- a/file1.copy.copy
> +++ b/file1.copy.copy
> @@ -1,1 +1,2 @@
>  file one
> +a change
> diff --git a/file2 b/file3
> copy from file2
> copy to file3
> --- a/file3
> +++ b/file3
> @@ -1,1 +1,2 @@
>  file two
> +modify overwritten
> diff --git a/file2 b/file4
> copy from file2
> copy to file4
$ cat file4
> file two

Refresh, pop and push
$ darn refresh
$ ls
> file1
> file1.copy
> file1.copy.copy
> file2
> file3
> file4
$ darn pop
> There are now no patches applied.
$ darn files first
> +: : file1.copy <<- file1
> +: : file1.copy.copy <<- file1
>  : : file3 <<- file2
>  : : file4 <<- file2
$ cat file3
> file three
$ cat file4
> file four
$ ls
> file1
> file2
> file3
> file4
$ darn push
> Patching file "file3".
> Patching file "file1.copy".
> Patching file "file1.copy.copy".
> Processing file "file4".
> Patch "first" is now on top
$ darn files
> +:+: file1.copy <<- file1
> +:+: file1.copy.copy <<- file1
>  :+: file3 <<- file2
>  :+: file4 <<- file2
$ darn diff --notimestamp
> diff --git a/file1 b/file1.copy
> copy from file1
> copy to file1.copy
> --- a/file1.copy
> +++ b/file1.copy
> @@ -1,1 +1,2 @@
>  file one
> +a change
> diff --git a/file1 b/file1.copy.copy
> copy from file1
> copy to file1.copy.copy
> --- a/file1.copy.copy
> +++ b/file1.copy.copy
> @@ -1,1 +1,2 @@
>  file one
> +a change
> diff --git a/file2 b/file3
> copy from file2
> copy to file3
> --- a/file3
> +++ b/file3
> @@ -1,1 +1,2 @@
>  file two
> +modify overwritten
> diff --git a/file2 b/file4
> copy from file2
> copy to file4
$ ls
> file1
> file1.copy
> file1.copy.copy
> file2
> file3
> file4

Drop the overwritten "tracked" file
$ darn drop file4
> file4: file dropped from patch "first".
$ darn files
> +:+: file1.copy <<- file1
> +:+: file1.copy.copy <<- file1
>  :+: file3 <<- file2
$ cat file4
> file four
$ darn diff --notimestamp
> diff --git a/file1 b/file1.copy
> copy from file1
> copy to file1.copy
> --- a/file1.copy
> +++ b/file1.copy
> @@ -1,1 +1,2 @@
>  file one
> +a change
> diff --git a/file1 b/file1.copy.copy
> copy from file1
> copy to file1.copy.copy
> --- a/file1.copy.copy
> +++ b/file1.copy.copy
> @@ -1,1 +1,2 @@
>  file one
> +a change
> diff --git a/file2 b/file3
> copy from file2
> copy to file3
> --- a/file3
> +++ b/file3
> @@ -1,1 +1,2 @@
>  file two
> +modify overwritten

Drop the overwritten "untracked" file
$ darn drop file3
> file3: file dropped from patch "first".
$ darn files
> +:+: file1.copy <<- file1
> +:+: file1.copy.copy <<- file1
$ cat file3
> file three
$ darn diff --notimestamp
> diff --git a/file1 b/file1.copy
> copy from file1
> copy to file1.copy
> --- a/file1.copy
> +++ b/file1.copy
> @@ -1,1 +1,2 @@
>  file one
> +a change
> diff --git a/file1 b/file1.copy.copy
> copy from file1
> copy to file1.copy.copy
> --- a/file1.copy.copy
> +++ b/file1.copy.copy
> @@ -1,1 +1,2 @@
>  file one
> +a change

Drop a simple copy
$ darn drop file1.copy
> file1.copy: file dropped from patch "first".
$ darn files
> +:+: file1.copy.copy <<- file1
$ cat file1
> file one
$ darn diff --notimestamp
> diff --git a/file1 b/file1.copy.copy
> copy from file1
> copy to file1.copy.copy
> --- a/file1.copy.copy
> +++ b/file1.copy.copy
> @@ -1,1 +1,2 @@
>  file one
> +a change

Pop and we should be back to the start
$ darn pop
> There are now no patches applied.
$ cat file1
> file one
$ cat file2
> file two
$ cat file3
> file three
$ cat file4
> file four
$ ls
> file1
> file2
> file3
> file4

Now test copying a tracked file
$ darn new second
$ darn add file1
> file1: file added to patch "second".
$ patch -e file1
< a
< add a line
< .
$ darn refresh
$ darn diff --notimestamp
> diff --git a/file1 b/file1
> --- a/file1
> +++ b/file1
> @@ -1,1 +1,2 @@
>  file one
> +add a line
$ darn copy file1 file1.copy
> file1: file copied to "file1.copy" in patch "second".
$ darn diff --notimestamp
> diff --git a/file1 b/file1
> --- a/file1
> +++ b/file1
> @@ -1,1 +1,2 @@
>  file one
> +add a line
> diff --git a/file1 b/file1.copy
> copy from file1
> copy to file1.copy
> --- a/file1.copy
> +++ b/file1.copy
> @@ -1,1 +1,2 @@
>  file one
> +add a line
$ darn refresh
$ darn pop
> There are now no patches applied.
$ darn push
> Patching file "file1".
> Patching file "file1.copy".
> Patch "second" is now on top
$ darn diff --notimestamp
> diff --git a/file1 b/file1
> --- a/file1
> +++ b/file1
> @@ -1,1 +1,2 @@
>  file one
> +add a line
> diff --git a/file1 b/file1.copy
> copy from file1
> copy to file1.copy
> --- a/file1.copy
> +++ b/file1.copy
> @@ -1,1 +1,2 @@
>  file one
> +add a line
$ darn files
>  :+: file1
> +:+: file1.copy <<- file1
$ darn drop file1
> file1: file dropped from patch "second".
$ darn files
> +:+: file1.copy <<- file1
$ darn diff --notimestamp
> diff --git a/file1 b/file1.copy
> copy from file1
> copy to file1.copy
> --- a/file1.copy
> +++ b/file1.copy
> @@ -1,1 +1,2 @@
>  file one
> +add a line
$ cat file1
> file one
$ darn pop
> There are now no patches applied.
$ darn push
> Patching file "file1.copy".
> Patch "second" is now on top
$ darn diff --notimestamp
> diff --git a/file1 b/file1.copy
> copy from file1
> copy to file1.copy
> --- a/file1.copy
> +++ b/file1.copy
> @@ -1,1 +1,2 @@
>  file one
> +add a line
$ darn files
> +:+: file1.copy <<- file1
