### Copyright (C) 2011 Peter Williams <peter_ono@users.sourceforge.net>
###
### This program is free software; you can redistribute it and/or modify
### it under the terms of the GNU General Public License as published by
### the Free Software Foundation; version 2 of the License only.
###
### This program is distributed in the hope that it will be useful,
### but WITHOUT ANY WARRANTY; without even the implied warranty of
### MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
### GNU General Public License for more details.
###
### You should have received a copy of the GNU General Public License
### along with this program; if not, write to the Free Software
### Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA

Test the 'darn copy' command.

Create test file tree.
$ darn_test_tree create

Make a playground and patch
$ darn init
$ darn new first
$ darn add file4 > /dev/null
$ darn_test_tree modify file4

Copy nonexistent file
$ darn copy nonexistent nonexistent.copy
? 2
! nonexistent: file does not exist.
$ darn copy nonexistent file1
? 2
! nonexistent: file does not exist.
$ darn copy nonexistent file4
? 2
! nonexistent: file does not exist.

Make a simple copy
$ darn copy file1 file1.copy
> file1: file copied to "file1.copy" in patch "first".
$ darn files
> +:+: file1.copy <<- file1
>  :?: file4
$ darn diff
> diff --git a/file1 b/file1.copy
> copy from file1
> copy to file1.copy
> diff --git a/file4 b/file4
> --- a/file4
> +++ b/file4
> @@ -1 +1,2 @@
>  file4: is a text file.
> +Patch: "first"; Path: "file4"
$ darn_test_tree modify file1.copy
$ darn diff
> diff --git a/file1 b/file1.copy
> copy from file1
> copy to file1.copy
> --- a/file1
> +++ b/file1.copy
> @@ -1 +1,2 @@
>  file1: is a text file.
> +Patch: "first"; Path: "file1.copy"
> diff --git a/file4 b/file4
> --- a/file4
> +++ b/file4
> @@ -1 +1,2 @@
>  file4: is a text file.
> +Patch: "first"; Path: "file4"
$ darn files
> +:?: file1.copy <<- file1
>  :?: file4

Copy a copy
$ darn copy file1.copy file1.copy.copy
> file1.copy: file copied to "file1.copy.copy" in patch "first".
$ darn files
> +:?: file1.copy <<- file1
> +:?: file1.copy.copy <<- file1
>  :?: file4
$ darn diff
> diff --git a/file1 b/file1.copy
> copy from file1
> copy to file1.copy
> --- a/file1
> +++ b/file1.copy
> @@ -1 +1,2 @@
>  file1: is a text file.
> +Patch: "first"; Path: "file1.copy"
> diff --git a/file1 b/file1.copy.copy
> copy from file1
> copy to file1.copy.copy
> --- a/file1
> +++ b/file1.copy.copy
> @@ -1 +1,2 @@
>  file1: is a text file.
> +Patch: "first"; Path: "file1.copy"
> diff --git a/file4 b/file4
> --- a/file4
> +++ b/file4
> @@ -1 +1,2 @@
>  file4: is a text file.
> +Patch: "first"; Path: "file4"

Simple overwrite
$ darn copy file2 file3
> file2: file copied to "file3" in patch "first".
$ darn files
> +:?: file1.copy <<- file1
> +:?: file1.copy.copy <<- file1
>  :+: file3 <<- file2
>  :?: file4
$ darn_test_tree modify file3
$ darn files
> +:?: file1.copy <<- file1
> +:?: file1.copy.copy <<- file1
>  :?: file3 <<- file2
>  :?: file4
$ darn diff
> diff --git a/file1 b/file1.copy
> copy from file1
> copy to file1.copy
> --- a/file1
> +++ b/file1.copy
> @@ -1 +1,2 @@
>  file1: is a text file.
> +Patch: "first"; Path: "file1.copy"
> diff --git a/file1 b/file1.copy.copy
> copy from file1
> copy to file1.copy.copy
> --- a/file1
> +++ b/file1.copy.copy
> @@ -1 +1,2 @@
>  file1: is a text file.
> +Patch: "first"; Path: "file1.copy"
> diff --git a/file2 b/file3
> copy from file2
> copy to file3
> --- a/file2
> +++ b/file3
> @@ -1 +1,2 @@
>  file2: is a text file.
> +Patch: "first"; Path: "file3"
> diff --git a/file4 b/file4
> --- a/file4
> +++ b/file4
> @@ -1 +1,2 @@
>  file4: is a text file.
> +Patch: "first"; Path: "file4"

Overwrite a tracked file
$ darn copy file2 file4
? 34
! file4: file already in patch.
$ darn copy --overwrite file2 file4
> file2: file copied to "file4" in patch "first".
$ darn diff
> diff --git a/file1 b/file1.copy
> copy from file1
> copy to file1.copy
> --- a/file1
> +++ b/file1.copy
> @@ -1 +1,2 @@
>  file1: is a text file.
> +Patch: "first"; Path: "file1.copy"
> diff --git a/file1 b/file1.copy.copy
> copy from file1
> copy to file1.copy.copy
> --- a/file1
> +++ b/file1.copy.copy
> @@ -1 +1,2 @@
>  file1: is a text file.
> +Patch: "first"; Path: "file1.copy"
> diff --git a/file2 b/file3
> copy from file2
> copy to file3
> --- a/file2
> +++ b/file3
> @@ -1 +1,2 @@
>  file2: is a text file.
> +Patch: "first"; Path: "file3"
> diff --git a/file2 b/file4
> copy from file2
> copy to file4
$ cat file4
> file2: is a text file.

Refresh, pop and push
$ darn refresh
$ ls --ignore=dir* --ignore=binary*
> file1
> file1.copy
> file1.copy.copy
> file2
> file3
> file4
> file5
$ darn pop
> There are now no patches applied.
$ darn files first
> +: : file1.copy <<- file1
> +: : file1.copy.copy <<- file1
>  : : file3 <<- file2
>  : : file4 <<- file2
$ cat file3
> file3: is a text file.
$ cat file4
> file4: is a text file.
$ ls --ignore=dir* --ignore=binary*
> file1
> file2
> file3
> file4
> file5
$ darn push > /dev/null
$ darn files
> +:+: file1.copy <<- file1
> +:+: file1.copy.copy <<- file1
>  :+: file3 <<- file2
>  :+: file4 <<- file2
$ darn diff
> diff --git a/file1 b/file1.copy
> copy from file1
> copy to file1.copy
> --- a/file1
> +++ b/file1.copy
> @@ -1 +1,2 @@
>  file1: is a text file.
> +Patch: "first"; Path: "file1.copy"
> diff --git a/file1 b/file1.copy.copy
> copy from file1
> copy to file1.copy.copy
> --- a/file1
> +++ b/file1.copy.copy
> @@ -1 +1,2 @@
>  file1: is a text file.
> +Patch: "first"; Path: "file1.copy"
> diff --git a/file2 b/file3
> copy from file2
> copy to file3
> --- a/file2
> +++ b/file3
> @@ -1 +1,2 @@
>  file2: is a text file.
> +Patch: "first"; Path: "file3"
> diff --git a/file2 b/file4
> copy from file2
> copy to file4
$ ls --ignore=dir* --ignore=binary*
> file1
> file1.copy
> file1.copy.copy
> file2
> file3
> file4
> file5

Drop the overwritten "tracked" file
$ darn drop file4 > /dev/null
$ darn files
> +:+: file1.copy <<- file1
> +:+: file1.copy.copy <<- file1
>  :+: file3 <<- file2
$ cat file4
> file4: is a text file.
$ darn diff
> diff --git a/file1 b/file1.copy
> copy from file1
> copy to file1.copy
> --- a/file1
> +++ b/file1.copy
> @@ -1 +1,2 @@
>  file1: is a text file.
> +Patch: "first"; Path: "file1.copy"
> diff --git a/file1 b/file1.copy.copy
> copy from file1
> copy to file1.copy.copy
> --- a/file1
> +++ b/file1.copy.copy
> @@ -1 +1,2 @@
>  file1: is a text file.
> +Patch: "first"; Path: "file1.copy"
> diff --git a/file2 b/file3
> copy from file2
> copy to file3
> --- a/file2
> +++ b/file3
> @@ -1 +1,2 @@
>  file2: is a text file.
> +Patch: "first"; Path: "file3"

Drop the overwritten "untracked" file
$ darn drop file3 > /dev/null
$ darn files
> +:+: file1.copy <<- file1
> +:+: file1.copy.copy <<- file1
$ cat file3
> file3: is a text file.
$ darn diff
> diff --git a/file1 b/file1.copy
> copy from file1
> copy to file1.copy
> --- a/file1
> +++ b/file1.copy
> @@ -1 +1,2 @@
>  file1: is a text file.
> +Patch: "first"; Path: "file1.copy"
> diff --git a/file1 b/file1.copy.copy
> copy from file1
> copy to file1.copy.copy
> --- a/file1
> +++ b/file1.copy.copy
> @@ -1 +1,2 @@
>  file1: is a text file.
> +Patch: "first"; Path: "file1.copy"

Drop a simple copy
$ darn drop file1.copy > /dev/null
$ darn files
> +:+: file1.copy.copy <<- file1
$ cat file1
> file1: is a text file.
$ darn diff
> diff --git a/file1 b/file1.copy.copy
> copy from file1
> copy to file1.copy.copy
> --- a/file1
> +++ b/file1.copy.copy
> @@ -1 +1,2 @@
>  file1: is a text file.
> +Patch: "first"; Path: "file1.copy"

Pop and we should be back to the start
$ darn pop
> There are now no patches applied.
$ cat file1
> file1: is a text file.
$ cat file2
> file2: is a text file.
$ cat file3
> file3: is a text file.
$ cat file4
> file4: is a text file.
$ ls --ignore=dir* --ignore=binary*
> file1
> file2
> file3
> file4
> file5

Now test copying a tracked file
$ darn new second
$ darn add file1 > /dev/null
$ darn_test_tree modify file1
$ darn refresh
$ darn diff
> diff --git a/file1 b/file1
> --- a/file1
> +++ b/file1
> @@ -1 +1,2 @@
>  file1: is a text file.
> +Patch: "second"; Path: "file1"
$ darn copy file1 file1.copy
> file1: file copied to "file1.copy" in patch "second".
$ darn diff
> diff --git a/file1 b/file1
> --- a/file1
> +++ b/file1
> @@ -1 +1,2 @@
>  file1: is a text file.
> +Patch: "second"; Path: "file1"
> diff --git a/file1 b/file1.copy
> copy from file1
> copy to file1.copy
> --- a/file1
> +++ b/file1.copy
> @@ -1 +1,2 @@
>  file1: is a text file.
> +Patch: "second"; Path: "file1"
$ darn refresh
$ darn pop > /dev/null
$ darn push > /dev/null
$ darn diff
> diff --git a/file1 b/file1
> --- a/file1
> +++ b/file1
> @@ -1 +1,2 @@
>  file1: is a text file.
> +Patch: "second"; Path: "file1"
> diff --git a/file1 b/file1.copy
> copy from file1
> copy to file1.copy
> --- a/file1
> +++ b/file1.copy
> @@ -1 +1,2 @@
>  file1: is a text file.
> +Patch: "second"; Path: "file1"
$ darn files
>  :+: file1
> +:+: file1.copy <<- file1
$ darn drop file1 > /dev/null
$ darn files
> +:+: file1.copy <<- file1
$ darn diff
> diff --git a/file1 b/file1.copy
> copy from file1
> copy to file1.copy
> --- a/file1
> +++ b/file1.copy
> @@ -1 +1,2 @@
>  file1: is a text file.
> +Patch: "second"; Path: "file1"
$ cat file1
> file1: is a text file.
$ darn pop > /dev/null
$ darn push > /dev/null
$ darn diff
> diff --git a/file1 b/file1.copy
> copy from file1
> copy to file1.copy
> --- a/file1
> +++ b/file1.copy
> @@ -1 +1,2 @@
>  file1: is a text file.
> +Patch: "second"; Path: "file1"
$ darn files
> +:+: file1.copy <<- file1

Bug #3465707
Test copying an untracked file and then adding the original
$ darn refresh
$ darn new third
$ darn copy dir5/file1 dir5/file1.copy
> dir5/file1: file copied to "dir5/file1.copy" in patch "third".
$ darn_test_tree modify dir5/file1.copy
$ darn add dir5/file1
> dir5/file1: file added to patch "third".
$ darn_test_tree modify dir5/file1
$ darn refresh
$ darn diff
> diff --git a/dir5/file1 b/dir5/file1
> --- a/dir5/file1
> +++ b/dir5/file1
> @@ -1 +1,2 @@
>  dir5/file1: is a text file.
> +Patch: "third"; Path: "dir5/file1"
> diff --git a/dir5/file1 b/dir5/file1.copy
> copy from dir5/file1
> copy to dir5/file1.copy
> --- a/dir5/file1
> +++ b/dir5/file1.copy
> @@ -1 +1,2 @@
>  dir5/file1: is a text file.
> +Patch: "third"; Path: "dir5/file1.copy"
$ darn pop > /dev/null
$ darn push
> Patching file "dir5/file1.copy".
> Patching file "dir5/file1".
> Patch "third" is now on top.
