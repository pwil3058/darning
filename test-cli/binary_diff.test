### Copyright (C) 2011 Peter Williams <peter_ono@users.sourceforge.net>
###
### This program is free software; you can redistribute it and/or modify
### it under the terms of the GNU General Public License as published by
### the Free Software Foundation; version 2 of the License only.
###
### This program is distributed in the hope that it will be useful,
### but WITHOUT ANY WARRANTY; without even the implied warranty of
### MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
### GNU General Public License for more details.
###
### You should have received a copy of the GNU General Public License
### along with this program; if not, write to the Free Software
### Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA

Test the 'darn diff' command.

Set up a small binary file tree and initialise a playground therein
$ mkdir sub1
$ mkdir sub2
$ mkdir sub2/sub1
$ mkfile -b file1
< File 1: arbitrary content
$ mkfile file2
< File 2: arbitrary content
$ mkfile -b file3
< File 3: arbitrary content
$ mkfile -b sub1/file1
< File 1-1: arbitrary content
$ mkfile -b sub1/file2
< File 1-2: arbitrary content
$ mkfile -b sub1/file3
< File 1-3: arbitrary content
$ mkfile -b sub2/file1
< File 2-1: arbitrary content
$ mkfile -b sub2/file2
< File 2-2: arbitrary content
$ mkfile -b sub2/file3
< File 2-3: arbitrary content
$ mkfile -b sub2/sub1/file1
< File 2-1-1: arbitrary content
$ mkfile -b sub2/sub1/file2
< File 2-1-2: arbitrary content
$ mkfile -b sub2/sub1/file3
< File 2-1-3: arbitrary content

$ darn init
$ darn new first --descr "First patch"
$ darn add file1 sub1/file1 sub2/file1 sub2/sub1/file1
> file1: file added to patch "first".
> sub1/file1: file added to patch "first".
> sub2/file1: file added to patch "first".
> sub2/sub1/file1: file added to patch "first".
$ patch -e file1
< a
< a new line
< .
$ patch -e sub1/file1
< a
< a new line
< .
$ patch -e sub2/file1
< a
< a new line
< .
$ patch -e sub2/sub1/file1
< a
< a new line
< .
$ darn refresh
$ darn diff --notimestamps
> diff --git a/file1 b/file1
> index e5a50f79269692f3473c4ea26d788e1ad61b3ad3..a36612129059465d4b1ed178a71be1762d1c3b5b 0100664
> GIT binary patch
> delta 16
> Xc$||~n;^}dsF0Uhu8@<Nm&yeIBn<?W
> 
> delta 4
> Lc$`y{o*)eX0w@6O
> 
> diff --git a/sub1/file1 b/sub1/file1
> index 1e1c2423e65cf74f2491da617b17f8aa98a12485..399b0221ca664ee12a166b6b3db01b010bebe4b5 0100664
> GIT binary patch
> delta 16
> Xc$|~fm>|oYsF0Uhu8@<Nm&yeIBxMAf
> 
> delta 4
> Lc%0LaogfPU0yqHk
> 
> diff --git a/sub2/file1 b/sub2/file1
> index 40e69c70ed9399c1ca5f6e397e0bc612658a64bd..aa6c8a8507e8400b0efadcea1e356f6ee4918311 0100664
> GIT binary patch
> delta 16
> Xc$|~fm>|oYsF0Uhu8@<Nm&yeIBxMAf
> 
> delta 4
> Lc%0LaogfPU0yqHk
> 
> diff --git a/sub2/sub1/file1 b/sub2/sub1/file1
> index 42d576940d727ebf05223c2926dd3c99a3b78549..847597b0211a341b36b5da5312cf8674d214f14d 0100664
> GIT binary patch
> delta 16
> Xc$|~hnjp`esF0Uhu8@<Nm&yeIB)tTo
> 
> delta 4
> Lc%0LcpCAta0!RS)
> 
$ darn diff --notimestamps > first.diff

$ darn new second --descr "Second patch"
$ darn add file1 sub1/file1 sub2/file1 sub2/sub1/file1
> file1: file added to patch "second".
> sub1/file1: file added to patch "second".
> sub2/file1: file added to patch "second".
> sub2/sub1/file1: file added to patch "second".
$ patch -e file1
< a
< another new line
< .
$ patch -e sub1/file1
< a
< another new line
< .
$ patch -e sub2/file1
< a
< another new line
< .
$ patch -e sub2/sub1/file1
< a
< another new line
< .
$ darn diff --notimestamps -P first > first.diff-1
$ diff first.diff first.diff-1
$ darn refresh
$ darn diff --notimestamps -P first > first.diff-2
$ diff first.diff first.diff-2
$ darn diff --notimestamps
> diff --git a/file1 b/file1
> index a36612129059465d4b1ed178a71be1762d1c3b5b..7a5666779b1c0ffb090e5058324e7e9a50c2d7c6 0100664
> GIT binary patch
> delta 22
> dc$`x+pP(j~n3rFYky@mXms+lnlbM&w1prc72T}k4
> 
> delta 4
> Lc$_m=o1g{&0+<05
> 
> diff --git a/sub1/file1 b/sub1/file1
> index 399b0221ca664ee12a166b6b3db01b010bebe4b5..8bd6b04ae5cefaff10e68fc436085433daa5416f 0100664
> GIT binary patch
> delta 22
> dc%0L)oS-3?n3rFYky@mXms+lnlbM&w1prdk2Uq|A
> 
> delta 4
> Lc$~A;n4kdw0;mBR
> 
> diff --git a/sub2/file1 b/sub2/file1
> index aa6c8a8507e8400b0efadcea1e356f6ee4918311..e65b95d4fe918fc4c487751259a7a59ed4505626 0100664
> GIT binary patch
> delta 22
> dc%0L)oS-3?n3rFYky@mXms+lnlbM&w1prdk2Uq|A
> 
> delta 4
> Lc$~A;n4kdw0;mBR
> 
> diff --git a/sub2/sub1/file1 b/sub2/sub1/file1
> index 847597b0211a341b36b5da5312cf8674d214f14d..83759159fdd6f39ef5712e5308a104abd4fbd5b4 0100664
> GIT binary patch
> delta 22
> dc%0L+o}eX|n3rFYky@mXms+lnlbM&w1prf02VMXG
> 
> delta 4
> Lc$~A=nxF*$0=NMn
> 
$ darn diff --notimestamps > second.diff
$ darn diff --notimestamps --combined
> diff --git a/file1 b/file1
> index e5a50f79269692f3473c4ea26d788e1ad61b3ad3..7a5666779b1c0ffb090e5058324e7e9a50c2d7c6 0100664
> GIT binary patch
> delta 33
> gc$||qpCB!hsF0Uhu8@<Nm&%oxmtT^RT7(b)0I@g<<NyEw
> 
> delta 4
> Lc$_nro*)eX0&D>O
> 
> diff --git a/sub1/file1 b/sub1/file1
> index 1e1c2423e65cf74f2491da617b17f8aa98a12485..8bd6b04ae5cefaff10e68fc436085433daa5416f 0100664
> GIT binary patch
> delta 33
> gc$|~9oFFTcsF0Uhu8@<Nm&%oxmtT^RT7(b)0I~K8>Hq)$
> 
> delta 4
> Lc$~A8ogfPU0(=1k
> 
> diff --git a/sub2/file1 b/sub2/file1
> index 40e69c70ed9399c1ca5f6e397e0bc612658a64bd..e65b95d4fe918fc4c487751259a7a59ed4505626 0100664
> GIT binary patch
> delta 33
> gc$|~9oFFTcsF0Uhu8@<Nm&%oxmtT^RT7(b)0I~K8>Hq)$
> 
> delta 4
> Lc$~A8ogfPU0(=1k
> 
> diff --git a/sub2/sub1/file1 b/sub2/sub1/file1
> index 42d576940d727ebf05223c2926dd3c99a3b78549..83759159fdd6f39ef5712e5308a104abd4fbd5b4 0100664
> GIT binary patch
> delta 33
> gc$|~Bo**xisF0Uhu8@<Nm&%oxmtT^RT7(b)0J5|S@Bjb+
> 
> delta 4
> Lc$~AApCAta0*nC)
>
$ diff -q first.diff second.diff
? 1
> Files first.diff and second.diff differ
$ darn diff --notimestamps --combined > combined.diff
$ diff -q first.diff combined.diff
? 1
> Files first.diff and combined.diff differ
$ diff -q second.diff combined.diff
? 1
> Files second.diff and combined.diff differ

Now check for individual files
$ darn diff --notimestamps sub1/file1
> diff --git a/sub1/file1 b/sub1/file1
> index 399b0221ca664ee12a166b6b3db01b010bebe4b5..8bd6b04ae5cefaff10e68fc436085433daa5416f 0100664
> GIT binary patch
> delta 22
> dc%0L)oS-3?n3rFYky@mXms+lnlbM&w1prdk2Uq|A
> 
> delta 4
> Lc$~A;n4kdw0;mBR
>
$ darn diff --notimestamps --combined sub1/file1
> diff --git a/sub1/file1 b/sub1/file1
> index 1e1c2423e65cf74f2491da617b17f8aa98a12485..8bd6b04ae5cefaff10e68fc436085433daa5416f 0100664
> GIT binary patch
> delta 33
> gc$|~9oFFTcsF0Uhu8@<Nm&%oxmtT^RT7(b)0I~K8>Hq)$
> 
> delta 4
> Lc$~A8ogfPU0(=1k
> 
$ darn diff --notimestamps sub1/file1 file1
> diff --git a/sub1/file1 b/sub1/file1
> index 399b0221ca664ee12a166b6b3db01b010bebe4b5..8bd6b04ae5cefaff10e68fc436085433daa5416f 0100664
> GIT binary patch
> delta 22
> dc%0L)oS-3?n3rFYky@mXms+lnlbM&w1prdk2Uq|A
> 
> delta 4
> Lc$~A;n4kdw0;mBR
> 
> diff --git a/file1 b/file1
> index a36612129059465d4b1ed178a71be1762d1c3b5b..7a5666779b1c0ffb090e5058324e7e9a50c2d7c6 0100664
> GIT binary patch
> delta 22
> dc$`x+pP(j~n3rFYky@mXms+lnlbM&w1prc72T}k4
> 
> delta 4
> Lc$_m=o1g{&0+<05
> 
$ darn diff --notimestamps --combined sub1/file1 file1
> diff --git a/sub1/file1 b/sub1/file1
> index 1e1c2423e65cf74f2491da617b17f8aa98a12485..8bd6b04ae5cefaff10e68fc436085433daa5416f 0100664
> GIT binary patch
> delta 33
> gc$|~9oFFTcsF0Uhu8@<Nm&%oxmtT^RT7(b)0I~K8>Hq)$
> 
> delta 4
> Lc$~A8ogfPU0(=1k
>
> diff --git a/file1 b/file1
> index e5a50f79269692f3473c4ea26d788e1ad61b3ad3..7a5666779b1c0ffb090e5058324e7e9a50c2d7c6 0100664
> GIT binary patch
> delta 33
> gc$||qpCB!hsF0Uhu8@<Nm&%oxmtT^RT7(b)0I@g<<NyEw
>
> delta 4
> Lc$_nro*)eX0&D>O
>

And make sure it works in a sub directory
$ cd sub2
$ darn diff --notimestamps file1 sub1/file1
> diff --git a/sub2/file1 b/sub2/file1
> index aa6c8a8507e8400b0efadcea1e356f6ee4918311..e65b95d4fe918fc4c487751259a7a59ed4505626 0100664
> GIT binary patch
> delta 22
> dc%0L)oS-3?n3rFYky@mXms+lnlbM&w1prdk2Uq|A
> 
> delta 4
> Lc$~A;n4kdw0;mBR
>
> diff --git a/sub2/sub1/file1 b/sub2/sub1/file1
> index 847597b0211a341b36b5da5312cf8674d214f14d..83759159fdd6f39ef5712e5308a104abd4fbd5b4 0100664
> GIT binary patch
> delta 22
> dc%0L+o}eX|n3rFYky@mXms+lnlbM&w1prf02VMXG
>
> delta 4
> Lc$~A=nxF*$0=NMn
>
