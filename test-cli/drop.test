### Copyright (C) 2011 Peter Williams <peter_ono@users.sourceforge.net>
###
### This program is free software; you can redistribute it and/or modify
### it under the terms of the GNU General Public License as published by
### the Free Software Foundation; version 2 of the License only.
###
### This program is distributed in the hope that it will be useful,
### but WITHOUT ANY WARRANTY; without even the implied warranty of
### MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
### GNU General Public License for more details.
###
### You should have received a copy of the GNU General Public License
### along with this program; if not, write to the Free Software
### Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA

Test the 'darn add' command.

Create some test files.
$ darn_test_tree create

Initialiaze a playground, create some patches and add the files to the patches
$ darn init
$ darn new first
$ darn add file1 file2 file3 nonexistent > /dev/null
$ darn_test_tree modify file1 file2 file3
$ darn refresh
$ darn new second
$ darn add file1 file2 file3 file4 nonexistent > /dev/null
$ darn_test_tree modify file1 file2 file3 file4
$ darn refresh
$ darn diff
> diff --git a/file1 b/file1
> --- a/file1
> +++ b/file1
> @@ -1,2 +1,3 @@
>  file1: is a text file.
>  Patch: "first"; Path: "file1"
> +Patch: "second"; Path: "file1"
> diff --git a/file2 b/file2
> --- a/file2
> +++ b/file2
> @@ -1,2 +1,3 @@
>  file2: is a text file.
>  Patch: "first"; Path: "file2"
> +Patch: "second"; Path: "file2"
> diff --git a/file3 b/file3
> --- a/file3
> +++ b/file3
> @@ -1,2 +1,3 @@
>  file3: is a text file.
>  Patch: "first"; Path: "file3"
> +Patch: "second"; Path: "file3"
> diff --git a/file4 b/file4
> --- a/file4
> +++ b/file4
> @@ -1 +1,2 @@
>  file4: is a text file.
> +Patch: "second"; Path: "file4"
> diff --git a/nonexistent b/nonexistent
$ darn new third
$ darn add file1 file2 file3 nonexistent > /dev/null
$ darn_test_tree modify file1 file2 file3
$ darn refresh
$ darn series
> +: first
> +: second
> +: third

Now test dropping files from an applied but non top patches
$ darn drop -P second file2 file3 file4
? 1
! Patch "second" is a NON-top applied patch. Aborted.
$ darn files second
>  :+: file1
>  :+: file2
>  :+: file3
>  :+: file4
> +:+: nonexistent
$ ls .darning.dbd/orig/second
> file1
> file2
> file3
> file4
$ ls .darning.dbd/stash/second
> file1
> file2
> file3
> file4
$ darn series
> +: first
> +: second
> +: third
$ darn diff -P second
> diff --git a/file1 b/file1
> --- a/file1
> +++ b/file1
> @@ -1,2 +1,3 @@
>  file1: is a text file.
>  Patch: "first"; Path: "file1"
> +Patch: "second"; Path: "file1"
> diff --git a/file2 b/file2
> --- a/file2
> +++ b/file2
> @@ -1,2 +1,3 @@
>  file2: is a text file.
>  Patch: "first"; Path: "file2"
> +Patch: "second"; Path: "file2"
> diff --git a/file3 b/file3
> --- a/file3
> +++ b/file3
> @@ -1,2 +1,3 @@
>  file3: is a text file.
>  Patch: "first"; Path: "file3"
> +Patch: "second"; Path: "file3"
> diff --git a/file4 b/file4
> --- a/file4
> +++ b/file4
> @@ -1 +1,2 @@
>  file4: is a text file.
> +Patch: "second"; Path: "file4"
> diff --git a/nonexistent b/nonexistent
$ darn diff
> diff --git a/file1 b/file1
> --- a/file1
> +++ b/file1
> @@ -1,3 +1,4 @@
>  file1: is a text file.
>  Patch: "first"; Path: "file1"
>  Patch: "second"; Path: "file1"
> +Patch: "third"; Path: "file1"
> diff --git a/file2 b/file2
> --- a/file2
> +++ b/file2
> @@ -1,3 +1,4 @@
>  file2: is a text file.
>  Patch: "first"; Path: "file2"
>  Patch: "second"; Path: "file2"
> +Patch: "third"; Path: "file2"
> diff --git a/file3 b/file3
> --- a/file3
> +++ b/file3
> @@ -1,3 +1,4 @@
>  file3: is a text file.
>  Patch: "first"; Path: "file3"
>  Patch: "second"; Path: "file3"
> +Patch: "third"; Path: "file3"
> diff --git a/nonexistent b/nonexistent

Now test dropping nonexistent overlapped file
$ darn drop -P second nonexistent
? 1
! Patch "second" is a NON-top applied patch. Aborted.
$ darn files second
>  :+: file1
>  :+: file2
>  :+: file3
>  :+: file4
> +:+: nonexistent
$ ls .darning.dbd/orig/second
> file1
> file2
> file3
> file4
$ ls .darning.dbd/stash/second
> file1
> file2
> file3
> file4
$ darn series
> +: first
> +: second
> +: third

Now test dropping a file from an unapplied patch
$ darn refresh
$ darn pop
> Patch "second" is now on top.
$ darn series
> +: first
> +: second
>  : third
$ darn drop -P third file1 nonexistent
> file1: file dropped from patch "third".
> nonexistent: file dropped from patch "third".
$ darn series
> +: first
> +: second
>  : third
$ ls .darning.dbd/orig/
> first
> second
$ ls .darning.dbd/stash/third
> file2
> file3

Now test dropping nonexistent non overlapped file
$ darn drop -P second nonexistent
> nonexistent: file dropped from patch "second".
$ darn files second
>  :+: file1
>  :+: file2
>  :+: file3
>  :+: file4

Now test dropping files from the top patch.
$ darn drop -P second file4
> file4: file dropped from patch "second".
$ darn diff -P second
> diff --git a/file1 b/file1
> --- a/file1
> +++ b/file1
> @@ -1,2 +1,3 @@
>  file1: is a text file.
>  Patch: "first"; Path: "file1"
> +Patch: "second"; Path: "file1"
> diff --git a/file2 b/file2
> --- a/file2
> +++ b/file2
> @@ -1,2 +1,3 @@
>  file2: is a text file.
>  Patch: "first"; Path: "file2"
> +Patch: "second"; Path: "file2"
> diff --git a/file3 b/file3
> --- a/file3
> +++ b/file3
> @@ -1,2 +1,3 @@
>  file3: is a text file.
>  Patch: "first"; Path: "file3"
> +Patch: "second"; Path: "file3"
$ darn drop file3
> file3: file dropped from patch "second".
$ darn diff
> diff --git a/file1 b/file1
> --- a/file1
> +++ b/file1
> @@ -1,2 +1,3 @@
>  file1: is a text file.
>  Patch: "first"; Path: "file1"
> +Patch: "second"; Path: "file1"
> diff --git a/file2 b/file2
> --- a/file2
> +++ b/file2
> @@ -1,2 +1,3 @@
>  file2: is a text file.
>  Patch: "first"; Path: "file2"
> +Patch: "second"; Path: "file2"
$ darn diff -P first
> diff --git a/file1 b/file1
> --- a/file1
> +++ b/file1
> @@ -1 +1,2 @@
>  file1: is a text file.
> +Patch: "first"; Path: "file1"
> diff --git a/file2 b/file2
> --- a/file2
> +++ b/file2
> @@ -1 +1,2 @@
>  file2: is a text file.
> +Patch: "first"; Path: "file2"
> diff --git a/file3 b/file3
> --- a/file3
> +++ b/file3
> @@ -1 +1,2 @@
>  file3: is a text file.
> +Patch: "first"; Path: "file3"
> diff --git a/nonexistent b/nonexistent

Now drop files that aren't in the patch
$ darn drop file3 file4
! file3: file not in patch "second": ignored.
! file4: file not in patch "second": ignored.
