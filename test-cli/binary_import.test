### Copyright (C) 2011 Peter Williams <peter_ono@users.sourceforge.net>
###
### This program is free software; you can redistribute it and/or modify
### it under the terms of the GNU General Public License as published by
### the Free Software Foundation; version 2 of the License only.
###
### This program is distributed in the hope that it will be useful,
### but WITHOUT ANY WARRANTY; without even the implied warranty of
### MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
### GNU General Public License for more details.
###
### You should have received a copy of the GNU General Public License
### along with this program; if not, write to the Free Software
### Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA

Test the 'darn import' command.

Set up a small binary file tree and initialise a playground therein
$ mkdir sub1
$ mkdir sub2
$ mkdir sub2/sub1
$ mkfile -b file1
< File 1: arbitrary content
$ mkfile file2
< File 2: arbitrary content
$ mkfile -b file3
< File 3: arbitrary content
$ mkfile -b sub1/file1
< File 1-1: arbitrary content
$ mkfile -b sub1/file2
< File 1-2: arbitrary content
$ mkfile -b sub1/file3
< File 1-3: arbitrary content
$ mkfile -b sub2/file1
< File 2-1: arbitrary content
$ mkfile -b sub2/file2
< File 2-2: arbitrary content
$ mkfile -b sub2/file3
< File 2-3: arbitrary content
$ mkfile -b sub2/sub1/file1
< File 2-1-1: arbitrary content
$ mkfile -b sub2/sub1/file2
< File 2-1-2: arbitrary content
$ mkfile -b sub2/sub1/file3
< File 2-1-3: arbitrary content

Make some binary patches
$ mkfile patch1
< diff --git a/file1 b/file1
< index e5a50f79269692f3473c4ea26d788e1ad61b3ad3..a36612129059465d4b1ed178a71be1762d1c3b5b 0100664
< GIT binary patch
< delta 16
< Xc$||~n;^}dsF0Uhu8@<Nm&yeIBn<?W
< 
< delta 4
< Lc$`y{o*)eX0w@6O
< 
< diff --git a/sub1/file1 b/sub1/file1
< index 1e1c2423e65cf74f2491da617b17f8aa98a12485..399b0221ca664ee12a166b6b3db01b010bebe4b5 0100664
< GIT binary patch
< delta 16
< Xc$|~fm>|oYsF0Uhu8@<Nm&yeIBxMAf
< 
< delta 4
< Lc%0LaogfPU0yqHk
< 
< diff --git a/sub2/file1 b/sub2/file1
< index 40e69c70ed9399c1ca5f6e397e0bc612658a64bd..aa6c8a8507e8400b0efadcea1e356f6ee4918311 0100664
< GIT binary patch
< delta 16
< Xc$|~fm>|oYsF0Uhu8@<Nm&yeIBxMAf
< 
< delta 4
< Lc%0LaogfPU0yqHk
< 
< diff --git a/sub2/sub1/file1 b/sub2/sub1/file1
< index 42d576940d727ebf05223c2926dd3c99a3b78549..847597b0211a341b36b5da5312cf8674d214f14d 0100664
< GIT binary patch
< delta 16
< Xc$|~hnjp`esF0Uhu8@<Nm&yeIB)tTo
< 
< delta 4
< Lc%0LcpCAta0!RS)
< 

$ mkfile patch2
< diff --git a/file1 b/file1
< index a36612129059465d4b1ed178a71be1762d1c3b5b..7a5666779b1c0ffb090e5058324e7e9a50c2d7c6 0100664
< GIT binary patch
< delta 22
< dc$`x+pP(j~n3rFYky@mXms+lnlbM&w1prc72T}k4
< 
< delta 4
< Lc$_m=o1g{&0+<05
< 
< diff --git a/sub1/file1 b/sub1/file1
< index 399b0221ca664ee12a166b6b3db01b010bebe4b5..8bd6b04ae5cefaff10e68fc436085433daa5416f 0100664
< GIT binary patch
< delta 22
< dc%0L)oS-3?n3rFYky@mXms+lnlbM&w1prdk2Uq|A
< 
< delta 4
< Lc$~A;n4kdw0;mBR
< 
< diff --git a/sub2/file1 b/sub2/file1
< index aa6c8a8507e8400b0efadcea1e356f6ee4918311..e65b95d4fe918fc4c487751259a7a59ed4505626 0100664
< GIT binary patch
< delta 22
< dc%0L)oS-3?n3rFYky@mXms+lnlbM&w1prdk2Uq|A
< 
< delta 4
< Lc$~A;n4kdw0;mBR
< 
< diff --git a/sub2/sub1/file1 b/sub2/sub1/file1
< index 847597b0211a341b36b5da5312cf8674d214f14d..83759159fdd6f39ef5712e5308a104abd4fbd5b4 0100664
< GIT binary patch
< delta 22
< dc%0L+o}eX|n3rFYky@mXms+lnlbM&w1prf02VMXG
< 
< delta 4
< Lc$~A=nxF*$0=NMn
< 


$ darn init
$ darn import patch1
> file1: file added to patch "patch1".
> sub1/file1: file added to patch "patch1".
> sub2/file1: file added to patch "patch1".
> sub2/sub1/file1: file added to patch "patch1".
> patch1: patch inserted at start of series.
> Imported "patch1" as patch "patch1".
$ darn series
>  : patch1
$ darn push
> Processing binary file "sub2/file1" with imported patch.
> Processing binary file "sub2/sub1/file1" with imported patch.
> Processing binary file "file1" with imported patch.
> Processing binary file "sub1/file1" with imported patch.
> Patch "patch1" is now on top.
$ darn series
> +: patch1
$ darn files
>  :+: file1
>  :+: sub1/file1
>  :+: sub2/file1
>  :+: sub2/sub1/file1

Make file1 incompatible with patch2
$ patch -e file1
< a
< a new line
< .
$ darn import patch2
> file1: file added to patch "patch2".
> sub1/file1: file added to patch "patch2".
> sub2/file1: file added to patch "patch2".
> sub2/sub1/file1: file added to patch "patch2".
> patch2: patch inserted after patch "patch1".
> Imported "patch2" as patch "patch2".
$ darn push
? 39
! file1: file has unrefreshed changes in (applied) patch "patch1".
! Aborted.
$ darn refresh
$ darn push
? 1
> Processing binary file "sub2/file1" with imported patch.
> Processing binary file "sub2/sub1/file1" with imported patch.
> Processing binary file "file1" with imported patch.
! "file1": imported binary delta can not be applied.
> Processing binary file "sub1/file1" with imported patch.
> Patch "patch2" is now on top.
! A refresh is required after issues are resolved.
$ darn series
> +: patch1
> ?: patch2
$ darn files
>  :?: file1
>  :+: sub1/file1
>  :+: sub2/file1
>  :+: sub2/sub1/file1
$ darn diff
> diff --git a/file1 b/file1
> index a36612129059465d4b1ed178a71be1762d1c3b5b..ad948a335d291836629977f9ba7fe908b472fbf5 0100664
> diff --git a/sub1/file1 b/sub1/file1
> index 399b0221ca664ee12a166b6b3db01b010bebe4b5..8bd6b04ae5cefaff10e68fc436085433daa5416f 0100664
> GIT binary patch
> delta 22
> dc%0L)oS-3?n3rFYky@mXms+lnlbM&w1prdk2Uq|A
> 
> delta 4
> Lc$~A;n4kdw0;mBR
> 
> diff --git a/sub2/file1 b/sub2/file1
> index aa6c8a8507e8400b0efadcea1e356f6ee4918311..e65b95d4fe918fc4c487751259a7a59ed4505626 0100664
> GIT binary patch
> delta 22
> dc%0L)oS-3?n3rFYky@mXms+lnlbM&w1prdk2Uq|A
> 
> delta 4
> Lc$~A;n4kdw0;mBR
> 
> diff --git a/sub2/sub1/file1 b/sub2/sub1/file1
> index 847597b0211a341b36b5da5312cf8674d214f14d..83759159fdd6f39ef5712e5308a104abd4fbd5b4 0100664
> GIT binary patch
> delta 22
> dc%0L+o}eX|n3rFYky@mXms+lnlbM&w1prf02VMXG
> 
> delta 4
> Lc$~A=nxF*$0=NMn
> 
$ darn refresh
$ darn series
> +: patch1
> +: patch2
$ darn files
>  :+: file1
>  :+: sub1/file1
>  :+: sub2/file1
>  :+: sub2/sub1/file1
$ darn diff
> diff --git a/file1 b/file1
> diff --git a/sub1/file1 b/sub1/file1
> index 399b0221ca664ee12a166b6b3db01b010bebe4b5..8bd6b04ae5cefaff10e68fc436085433daa5416f 0100664
> GIT binary patch
> delta 22
> dc%0L)oS-3?n3rFYky@mXms+lnlbM&w1prdk2Uq|A
> 
> delta 4
> Lc$~A;n4kdw0;mBR
> 
> diff --git a/sub2/file1 b/sub2/file1
> index aa6c8a8507e8400b0efadcea1e356f6ee4918311..e65b95d4fe918fc4c487751259a7a59ed4505626 0100664
> GIT binary patch
> delta 22
> dc%0L)oS-3?n3rFYky@mXms+lnlbM&w1prdk2Uq|A
> 
> delta 4
> Lc$~A;n4kdw0;mBR
> 
> diff --git a/sub2/sub1/file1 b/sub2/sub1/file1
> index 847597b0211a341b36b5da5312cf8674d214f14d..83759159fdd6f39ef5712e5308a104abd4fbd5b4 0100664
> GIT binary patch
> delta 22
> dc%0L+o}eX|n3rFYky@mXms+lnlbM&w1prf02VMXG
> 
> delta 4
> Lc$~A=nxF*$0=NMn
> 

$ darn pop
> Patch "patch1" is now on top.
$ darn series
> +: patch1
>  : patch2
$ darn files
>  :+: file1
>  :+: sub1/file1
>  :+: sub2/file1
>  :+: sub2/sub1/file1

$ darn pop
> There are now no patches applied.
$ darn series
>  : patch1
>  : patch2
$ darn files
? 1
! No patches applied.

$ darn push
> Processing binary file "sub2/file1".
> Processing binary file "sub2/sub1/file1".
> Processing binary file "file1".
> Processing binary file "sub1/file1".
> Patch "patch1" is now on top.
$ darn series
> +: patch1
>  : patch2
$ darn files
>  :+: file1
>  :+: sub1/file1
>  :+: sub2/file1
>  :+: sub2/sub1/file1

$ darn push
> Processing binary file "sub2/file1".
> Processing binary file "sub2/sub1/file1".
> Processing file "file1".
> Processing binary file "sub1/file1".
> Patch "patch2" is now on top.
$ darn series
> +: patch1
> +: patch2
$ darn files
>  :+: file1
>  :+: sub1/file1
>  :+: sub2/file1
>  :+: sub2/sub1/file1

$ darn diff
> diff --git a/file1 b/file1
> diff --git a/sub1/file1 b/sub1/file1
> index 399b0221ca664ee12a166b6b3db01b010bebe4b5..8bd6b04ae5cefaff10e68fc436085433daa5416f 0100664
> GIT binary patch
> delta 22
> dc%0L)oS-3?n3rFYky@mXms+lnlbM&w1prdk2Uq|A
> 
> delta 4
> Lc$~A;n4kdw0;mBR
> 
> diff --git a/sub2/file1 b/sub2/file1
> index aa6c8a8507e8400b0efadcea1e356f6ee4918311..e65b95d4fe918fc4c487751259a7a59ed4505626 0100664
> GIT binary patch
> delta 22
> dc%0L)oS-3?n3rFYky@mXms+lnlbM&w1prdk2Uq|A
> 
> delta 4
> Lc$~A;n4kdw0;mBR
> 
> diff --git a/sub2/sub1/file1 b/sub2/sub1/file1
> index 847597b0211a341b36b5da5312cf8674d214f14d..83759159fdd6f39ef5712e5308a104abd4fbd5b4 0100664
> GIT binary patch
> delta 22
> dc%0L+o}eX|n3rFYky@mXms+lnlbM&w1prf02VMXG
> 
> delta 4
> Lc$~A=nxF*$0=NMn
> 
